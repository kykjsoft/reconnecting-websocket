(function(e,n){if(typeof define==="function"&&define.amd){define([],n)}else if(typeof module!=="undefined"&&module.exports){module.exports=n()}else{e.ReconnectingWebSocket=n()}})(this,function(){if(!("WebSocket"in window)){return}function p(e,n,t){var o={debug:false,automaticOpen:true,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3,maxReconnectAttempts:null,binaryType:"blob"};if(!t){t={}}for(var c in o){if(typeof t[c]!=="undefined"){this[c]=t[c]}else{this[c]=o[c]}}this.url=e;this.reconnectAttempts=0;this.readyState=WebSocket.CONNECTING;this.protocol=null;var s=this;var r;var a=false;var u=false;var d=document.createElement("div");var l=false;d.addEventListener("open",function(e){s.onopen(e)});d.addEventListener("close",function(e){s.onclose(e)});d.addEventListener("connecting",function(e){s.onconnecting(e)});d.addEventListener("message",function(e){s.onmessage(e)});d.addEventListener("error",function(e){s.onerror(e)});this.addEventListener=d.addEventListener.bind(d);this.removeEventListener=d.removeEventListener.bind(d);this.dispatchEvent=d.dispatchEvent.bind(d);function f(e,n){var t=document.createEvent("CustomEvent");t.initCustomEvent(e,false,false,n);return t}this.open=function(c){r=new WebSocket(s.url,n||[]);r.binaryType=this.binaryType;if(c){if(this.maxReconnectAttempts&&this.reconnectAttempts>this.maxReconnectAttempts){return}}else{d.dispatchEvent(f("connecting"));this.reconnectAttempts=0}if(s.debug||p.debugAll){console.debug("ReconnectingWebSocket","attempt-connect",s.url)}var e=r;var i=setTimeout(function(){if(s.debug||p.debugAll){console.debug("ReconnectingWebSocket","connection-timeout",s.url)}u=true;e.close();u=false},s.timeoutInterval);r.onopen=function(e){clearTimeout(i);if(s.debug||p.debugAll){console.debug("ReconnectingWebSocket","onopen",s.url)}s.protocol=r.protocol;s.readyState=WebSocket.OPEN;s.reconnectAttempts=0;if(l===false){l=true;var n=f("ready");n.isReconnect=c;d.dispatchEvent(n)}else{var t=f("reconnected");t.isReconnect=c;d.dispatchEvent(t)}var o=f("open");o.isReconnect=c;c=false;d.dispatchEvent(o)};r.onclose=function(e){clearTimeout(t);r=null;if(a){s.readyState=WebSocket.CLOSED;d.dispatchEvent(f("close"))}else{s.readyState=WebSocket.CONNECTING;var n=f("connecting");n.code=e.code;n.reason=e.reason;n.wasClean=e.wasClean;d.dispatchEvent(n);if(!c&&!u){if(s.debug||p.debugAll){console.debug("ReconnectingWebSocket","onclose",s.url)}d.dispatchEvent(f("close"))}var t=s.reconnectInterval*Math.pow(s.reconnectDecay,s.reconnectAttempts);setTimeout(function(){s.reconnectAttempts++;s.open(true)},t>s.maxReconnectInterval?s.maxReconnectInterval:t)}};r.onmessage=function(e){if(s.debug||p.debugAll){console.debug("ReconnectingWebSocket","onmessage",s.url,e.data)}var n=f("message");n.data=e.data;d.dispatchEvent(n)};r.onerror=function(e){if(s.debug||p.debugAll){console.debug("ReconnectingWebSocket","onerror",s.url,e)}d.dispatchEvent(f("error"))}};if(this.automaticOpen==true){this.open(false)}this.send=function(n){if(r&&p.OPEN==r.readyState){if(this.debug||p.debugAll){console.debug("ReconnectingWebSocket","send",s.url,n)}return Promise.resolve(r.send(n))}else{console.debug("ReconnectingWebSocket","addSendOnceOpen",s.url,n);return new Promise(function(e){s.once("open",function(){console.debug("ReconnectingWebSocket","send",s.url,n);e(s.send(n))})})}};this.once=function(e,n){this.addEventListener(e,function(){n.apply(s,arguments);s.removeEventListener("message",n)})};this.sendnow=function(e){if(r){if(s.debug||p.debugAll){console.debug("ReconnectingWebSocket","send",s.url,e)}return r.send(e)}else{throw"INVALID_STATE_ERR : Pausing to reconnect websocket"}};this.close=function(e,n){if(typeof e=="undefined"){e=1e3}a=true;if(r){r.close(e,n)}};this.refresh=function(){if(r){r.close()}}}p.prototype.onopen=function(e){};p.prototype.onclose=function(e){};p.prototype.onconnecting=function(e){};p.prototype.onmessage=function(e){};p.prototype.onerror=function(e){};p.debugAll=false;p.CONNECTING=WebSocket.CONNECTING;p.OPEN=WebSocket.OPEN;p.CLOSING=WebSocket.CLOSING;p.CLOSED=WebSocket.CLOSED;return p});